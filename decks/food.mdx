import { CodeSurfer as Surfer } from "code-surfer";
import { CodeSurferColumns, Step } from "code-surfer";
import { Appear, Background } from "gatsby-theme-mdx-deck";
import * as L from "../src/layout";
import customTheme from "../src/theme";
import GreetingLoader from "./src/greeting-loader";

export const theme = customTheme;

<!-- import images -->
import lines from '../assets/lines.png'
// import pm_icon from '../assets/pm-icon.png'
// import pm_screen from '../assets/pm-screen.png'
// import new_button from '../assets/new.png'
// import templates from '../assets/templates.png'
// import search from '../assets/search.png'
// import howto from '../assets/howto.png'
// import visualizer from '../assets/visualizer.png'
// import template from '../assets/template.png'
// import visualize_1 from '../assets/visualize-1.png'
// import pretty from '../assets/pretty.png'
// import usa_graph from '../assets/USA Graph.png'
// import china from '../assets/china.png'
// import global_graph from '../assets/Global Graph.PNG'
// import iso from '../assets/ISO.png'
// import russel from '../assets/russel.png'
// import iso_code from '../assets/ISO Code.png'
// import china_before_colors from "../assets/China Colors Before.png"
// import image from "../assets/image.png"
// import image_1 from "../assets/image (1).png"
// import image_2 from "../assets/image (2).png" 

<L.Column>

# Visualizing COVID-19 with Postman

</L.Column>

---

<CodeSurferColumns sizes={[1, 2]}>
  
<Step subtitle="Here is a simple React component">
  
<GreetingLoader />

```jsx file=./src/greeting.1.1.js
```

</Step>

<Step subtitle="we want to make the 'name' editable">
    
<GreetingLoader />

```jsx 7 file=./src/greeting.1.1.js
```

</Step>
  
<Step subtitle="so we turn the component into a class">
    
<GreetingLoader version="class.1.1" />

```jsx file=./src/greeting.class.1.1.js
```

</Step>

<Step subtitle="add some state">

<GreetingLoader version="class.1.2" />

```jsx file=./src/greeting.class.1.2.js
```

</Step>

<Step subtitle="and add a change handler that calls setState">

<GreetingLoader version="class.1.3" />

```jsx 10:12,15:17,25 file=./src/greeting.class.1.3.js
```

</Step>

<Step subtitle="we can now edit the name and it should work">

<GreetingLoader version="class.1.3" />

```jsx 1:31 file=./src/greeting.class.1.3.js
```

</Step>

</CodeSurferColumns>

---
<Background />
<L.Column sx={{ minHeight: '0' }}>

## Disclaimer

### Information in this talk may not be accurate or may change in the future

</L.Column>

---

<L.Row>

## Time Slicing

### "Chunking slow rendering on subtree into little blocks of work by interrupting the work loop."

</L.Row>

---

import DanDemoBlocking from '../assets/dan-demo-blocking.png';

<img src={DanDemoBlocking} />

---

import DanDemoConcurrent from '../assets/dan-demo-concurrent.png';

<img src={DanDemoConcurrent} />

---

<Background />

### "Wait a minute... I already know about this! What is this talk really about?"

---

<L.Column>

# Concurrent Mode

## A chain of unfortunate consequences

</L.Column>

---

<Background />

### How does React "delay" rendering?

---

<L.Column>

## Sources of Slowdown

- Slow component render functions
- Slow state setter or reducer updater functions
- Slow effect functions

</L.Column>

---

import DeferredSetState from '../assets/deferred-setstate.svg';

<L.Row>

## Deferred setState.

### Any state setter or dispatch can be delayed.

</L.Row>

<DeferredSetState />

---

import InterruptRendering from '../assets/interrupt-rendering.svg';

<L.Row>

## Interrupt Rendering.

### Any rendering can be interrupted and can be completed later before committing.

</L.Row>

<InterruptRendering />

---

<L.Row>

## Oops #1

### Delaying rendering is only safe when no effects are pending on a subtree.

</L.Row>

---

import HooksAPI from '../assets/hooks-api.svg';

<L.Row>

## The Hooks API.

### This restriction is reflected in the hooks API with encapsulation of effects.

</L.Row>

<HooksAPI />

---

import HooksAPITiming from '../assets/hooks-api-timing.svg';

<L.Row>

## Hooks Timings.

### With each hook we observe a part of the lifecycle and can react.

</L.Row>

<HooksAPITiming />

---

import ComponentLifecycle from '../assets/component-lifecycle.svg';

<L.Row>

## The Lifecycle.

### The lifecycle we observe has three phases repeating.

</L.Row>

<ComponentLifecycle />

---

<L.Column>

## Add the Line Graph

<p> Once we pass the COVID-19 data  we can create the time series model using chart.js!
</p>
<p> You would first create a canvas by using this HTML command within the template variable
   `<canvas id="myChart"></canvas>`.
</p>
<p> Then you would call this JavaScript command above the HTML command
    to initialize Chart.js library, `<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>`
</p> 
<p> After that, you would write the JavaScript code written below between the two `script` parameters to form the body that passes the
    dates and data values of our dataset.
</p>
<p> Finally you can run the code by clicking on the send button and the visulaize button and viola! We have our time series model!
</p>

</L.Column>

<R.Column>

<img src = {usa_graph} />

</R.Column>

<Notes>
  <p> We can see here that the cases for COVID-19 have been stagnant throughout January and February, but then they start to increase
      in March. This means that as time goes on after March, the number of COVID-19 cases increase, meaning the disease is starting to
      spread much throughout the US during this time.
  </p>
</Notes>
  
---

<L.Column>

## Show Time Series for another country

<p> We saw in the previous example that we displayed the time series of COVID-19 cases in the US, but what about other countries?
</p>
<p> Well, you're in luck! Notice how on the GET search bar, we already have the API key for our 
  dataset, `https://covidapi.info/api/v1/country/USA`, but the `USA` value after `/country/` represents the specfic country that we
  selected to show the time series for.
</p>
<p> Now what you can do is simply change that parameter for another country. Let's look at the rate of COVID-19 cases for. China's value is known as `CHN`. So you would would replace `USA` with `CHN` after the `/country/` parameter like so
  `https://covidapi.info/api/v1/country/CHN`.
</p>
<p> Once you have completed each step, you click send and visualize right after, and voila! You now have the time series model for China.
</p>

</L.Column>

<R.Column>

<img src = {china} />

</R.Column>

---

<L.Column>

## Show Time Series for another Value

<p> We've already showed many ways of displaying time series data for COVID-19 cases for a country, but what if we ant to see it on a global scale?
</p>
<p> Well you can now do that through editing the API key from the GET search bar.
</p>
<p> Now if we look at the API key `https://covidapi.info/api/v1/country/CHN`, notice how the `/country/` parameter focuses on the location of each country and `CHN` is the country, China?
</p>
<p> Now what you can do is replace both parameters with `/global/` to let the API key know that you want every country in the world and after that, you would `/count/` for every international case of COVID-19.
</p>
<p> Your API key on the GET search bar will look like this, `https://covidapi.info/api/v1/global/count`, and after clicking search and visualize, you just created another time series model for the entire world.
</p>

</L.Column>

---

<L.Row>

## Oops #2

### It's not possible to have a subscription or effect track the component lifecycle.

</L.Row>

---

<L.Row>

## Workaround

### Resort to useSubscription

</L.Row>

---

import SchedulerPriorities from '../assets/scheduler-priorities.svg';

<L.Row>

## Scheduler Priorities.

### In Concurrent Mode the time budgets are switched on for time slicing.

</L.Row>

<SchedulerPriorities />

---

<L.Row>

## Oops #3

### Seems like React isn't all that predictable anymore.

</L.Row>

---

<L.Row>

## Workaround

### Synchronous Subscriber and scheduled teardown

</L.Row>

https://github.com/facebook/react/issues/15317#issuecomment-573337558

---

<Background />

### "We didn't yet get to what happens when an effect is slow, right?"

---

<L.Row>

## Tearing

### "When a subtree's renderered state falls behind while another subtree has committed updates already."

</L.Row>

---

import Tearing1 from '../assets/bvaughn-tearing-1.png';
import Tearing2 from '../assets/bvaughn-tearing-2.png';

<L.Row>
<img src={Tearing2} />
<img src={Tearing1} />
</L.Row>

---

<L.Column>

## React's solution?

- When an effect slows down, React can't safely interrupt or delay updates.
- Instead it batches all updates and switches back to blocking mode
- This is called a _deopt_.

</L.Column>

---

<L.Row>

## Oops #4

### React Concurrent's deopt can be slower than Blocking was before.

</L.Row>

---

<L.Column>

## However

- This may still cause _tearing_ when another update is scheduled during this blocking batch.

</L.Column>

---

<L.Row>

## Oops #5

### A new `useMutableSource` hook is necessary to fix this tearing-during-deopt issue.

</L.Row>

---

<L.Column>

# Concurrent Mode: Oops

</L.Column>
